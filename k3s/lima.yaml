# /etc/lima/k3s/lima.yaml
arch: "aarch64"
cpus: 6
memory: "16GiB"
disk: "80GiB"

# 使用 Ubuntu 22.04 LTS
images:
  - location: "https://cloud-images.ubuntu.com/releases/22.04/release/ubuntu-22.04-server-cloudimg-arm64.img"
    arch: "aarch64"

# 掛載點配置
mounts:
  - location: "/opt/lima-k3s/data"
    writable: true
  - location: "/opt/lima-k3s/logs"
    writable: true
  - location: "/opt/lima-k3s/configs"
    writable: true

# 端口轉發配置
portForwards:
  # K3s API Server - 供 kubectl 和 Tailscale 遠端連線
  - guestPort: 6443
    hostPort: 6443
    proto: tcp
  # Envoy Gateway 常用端口
  - guestPort: 80
    hostPort: 8080
    proto: tcp
  - guestPort: 443
    hostPort: 8443
    proto: tcp
  # K3s NodePort 範圍 (30000-32767)
  - guestPort: 30000
    hostPort: 30000
    proto: tcp
  - guestPort: 30001
    hostPort: 30001
    proto: tcp
  - guestPort: 30002
    hostPort: 30002
    proto: tcp

# 預裝套件
provision:
  - mode: system
    script: |
      #!/bin/bash
      apt-get update -y
      apt-get install -y curl
      # 安裝 k3s
      curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="server --disable traefik" sh -